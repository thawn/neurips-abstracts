name: Tests

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    test:
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python-version: ["3.11", "3.12", "3.13"]

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Needed for setuptools_scm to determine version

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev,web]"

            - name: Run tests (excluding slow and e2e tests)
              run: |
                  pytest tests/ -v --cov=neurips_abstracts --cov-report=xml --cov-report=term-missing -m "not slow and not e2e"

            - name: Upload coverage to Codecov
              if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  fail_ci_if_error: false
                  token: ${{ secrets.CODECOV_TOKEN }}

    lint:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install ruff mypy types-requests

            - name: Lint with ruff
              run: |
                  ruff check src/ tests/ --output-format=github
              continue-on-error: true

            - name: Type check with mypy
              run: |
                  mypy src/ --ignore-missing-imports
              continue-on-error: true

    javascript-tests:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run JavaScript tests
              run: npm test

            - name: Upload JavaScript coverage
              if: always()
              uses: codecov/codecov-action@v4
              with:
                  files: ./coverage/coverage-final.json
                  flags: javascript
                  fail_ci_if_error: false
                  token: ${{ secrets.CODECOV_TOKEN }}
